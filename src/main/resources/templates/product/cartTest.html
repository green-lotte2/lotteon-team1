
<!----- cartTest 기존 코드..! ------->
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>롯데ON::롯데 온라인 쇼핑몰</title>
    <link rel="shortcut icon" type="image/x-icon" th:href="@{/images/favicon.ico}" />
    <script th:src="@{https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js}"></script>
    <script th:src="@{https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js}"></script>
    <script th:src="@{https://kit.fontawesome.com/20962f3e4b.js}" crossorigin="anonymous"></script>
    <script th:src="@{https://cdn.jsdelivr.net/bxslider/4.2.12/jquery.bxslider.min.js}"></script>
    <link rel="stylesheet" th:href="@{https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css}"/>
    <link rel="stylesheet" th:href="@{https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css}"/>
    <link rel="stylesheet" th:href="@{https://cdn.jsdelivr.net/bxslider/4.2.12/jquery.bxslider.css}"/>
    <link rel="stylesheet" th:href="@{/css/common.css}" />
    <link rel="stylesheet" th:href="@{/css/product/product.css}" />
    <!--cart 페이지는 카테고리 탭이 없어야하므로 layout처리 안함-->

    <script>
        window.onload = function (){

            const allCheckbox = document.querySelector('input[name="all"]');
            const selectedCartCheckboxes = document.querySelectorAll('input[name="selectedCart"]');




            // all 체크 누르면 모든 체크박스 체크
            allCheckbox.addEventListener('click', function (){
                selectedCartCheckboxes.forEach(function (checkbox){
                    checkbox.checked = allCheckbox.checked;
                });

            });

            const cartDelete = document.getElementById('cartDelete');

            // 딜리트 버튼 클릭시 삭제 로직
            cartDelete.onclick = function (e){
                e.preventDefault();
                var selectedCart = document.getElementsByName('selectedCart');
                var selectedCartList = [];
                var rowsToDelete = [];

                selectedCart.forEach(function (checkbox) {
                    if (checkbox.checked){
                        var inputField = checkbox.parentNode.querySelector('input[type="hidden"]');
                        var cartProdNo = inputField.value;
                        selectedCartList.push(cartProdNo);
                        var row = checkbox.closest('.productList');
                        rowsToDelete.push(row);
                    }
                });
                console.log('Selected Cart Product Numbers:', selectedCartList);
                console.log('Rows to Delete:', rowsToDelete);

                console.log(selectedCartList);
                var result = confirm("장바구니에서 삭제하시겠습니까?");
                if (result){
                    const jsonDate = {
                        cartProdNo : selectedCartList
                    };
                    fetchPut(`/lotteon/cart/delete`, jsonDate)
                        .then(data => {
                            console.log(data); // 서버로부터 받은 데이터 출력 또는 처리
                            alert("삭제되었습니다.");
                            rowsToDelete.forEach(function (row) {
                                row.remove();
                                if (allCheckbox.checked){
                                    allCheckbox.checked = false;
                                }
                            });
                        })
                        .catch(error => {
                            console.error(error); // 오류 처리
                        });
                }
            }

        }
        /* +, - 버튼 눌렀을 때 동작하며 할인 금액 계산하여 총 액에나타나게함 */
        function changeNum(change) {
            var numInput = event.target.parentNode.querySelector('input');
            var productInfo = event.target.closest('.productInfo');
            // 할인 전,후 가격 요소 선택
            var orgPriceElement = productInfo.querySelector('.org_price span');
            var inputOrgPrice = productInfo.querySelector('.org_price input.price');
            var disPriceElement = productInfo.querySelector('.dis_price');
            var discount = productInfo.querySelector('.dis_prod').value;
            //var inputOrgElement = orgPriceElement.querySelector('input');
            console.log(inputOrgPrice);
            console.log("discount:"+discount);

            var orgPriceValue = inputOrgPrice.value;
            console.log("org :" + orgPriceValue);

            var currentValue = parseInt(numInput.value) + change;
            // 최소값은 1, 최대값은 99로 제한
            if (currentValue < 1) {
                currentValue = 1;
            } else if (currentValue > 99) {
                currentValue = 99;
            }

            numInput.value = currentValue; // 변경된 값 적용
            console.log("갯수"+currentValue);

            var orgTotalPrice = orgPriceValue * currentValue;
            var disTotalPrice = orgPriceValue *(100 - discount) * currentValue * 0.01;
            console.log("원금"+orgTotalPrice);
            console.log("할인"+disTotalPrice);
            if (!isNaN(orgTotalPrice)) {
                // 금액 콤마 표시를 위해 포멧팅
                var fOrgTotalPrive = new Intl.NumberFormat('ko-KR').format(orgTotalPrice);
                orgPriceElement.innerHTML = fOrgTotalPrive;

            }
            if (!isNaN(disTotalPrice)){
                var fDisTotalPrive = new Intl.NumberFormat('ko-KR').format(disTotalPrice);
                disPriceElement.innerHTML = fDisTotalPrive;
            }

            // 수량 조절한 상품의 체크박스가 체크 되었는지 확인

            // 체크 되었으면 합산 가격 조정
            var aa = event.target.parentNode.parentNode.parentNode.parentNode.parentNode;
            calculateTotalPrice(aa);
            // 체크 안되면 끝

        }

        // 체크 된 상품 금액 계산
        function calculateTotalPrice(aa){

            console.log("calculateTotalPrice...1 : " + this);
            console.log("aa" + aa);
            let sumOrgPrice = 0;
            let discountPrice = 0;
            let sumTotalPrice = 0;
            let deliveryFeeList = [];
            let maxDeliveryFee = 0;
            let listForCompany = aa;
            console.log("1" + listForCompany);

            if (aa === undefined) {
                console.log("2" + listForCompany);
                listForCompany = event.target.parentNode.parentNode.parentNode;
            }
            console.log("3" + listForCompany);

            const listForCompanyChecks = listForCompany.querySelectorAll('input[name="selectedCart"]');

            listForCompanyChecks.forEach(function (checkbox){

                //const listForCompany = checkbox.closest('.listForCompany');
                console.log("calculateTotalPrice...2 : " + listForCompany);

                const orgPrice = listForCompany.querySelector('.sum_org_price');
                const disPrice = listForCompany.querySelector('.discount_price');
                const deliveryPrice = listForCompany.querySelector('.delivery_price');
                const totalPrice = listForCompany.querySelector('.total_price');

                //console.log("원금 :" + orgPrice + "할인" + disPrice + "합 :" + totalPrice);

                if (checkbox.checked){

                    console.log("calculateTotalPrice...3");
                    const cartItem = checkbox.closest('.productInfo');
                    const priceOrgElement = cartItem.querySelector('.org_price_value');
                    const priceDisElement = cartItem.querySelector('.dis_price');
                    const deliveryPrice = cartItem.querySelector('.delivery_fee');
                    console.log(deliveryPrice);

                    if (deliveryPrice.value){
                        deliveryFeeList.push(deliveryPrice.value);
                    }

                    maxDeliveryFee = Math.max(...deliveryFeeList);


                    //console.log(cartItem.innerHTML);
                    //console.log("orgin: " + priceOrgElement.innerHTML + "dis :" + priceDisElement.innerHTML);

                    const orgPriceText = priceOrgElement.innerText; // 체크된 상품의 가격
                    const disPriceText = priceDisElement.innerText; // 체크된 상품의 가격
                    var orgParsePrice = parseFloat(orgPriceText.replace(',', ''));
                    var disParsePrice = parseFloat(disPriceText.replace(',', ''));

                    sumOrgPrice += orgParsePrice;
                    discountPrice += orgParsePrice - disParsePrice;
                    sumTotalPrice += disParsePrice + maxDeliveryFee;

                    //console.log("원금총합 :" + sumOrgPrice.toLocaleString() + "할인총합 :" + discountPrice.toLocaleString());
                }

                orgPrice.textContent = ' 상품 ' + sumOrgPrice.toLocaleString() + '원';
                deliveryPrice.textContent = ' + 배송비' + maxDeliveryFee.toLocaleString() + '원';
                disPrice.textContent = ' - 할인 ' + discountPrice.toLocaleString() + '원';
                totalPrice.textContent = ' = 총 ' + sumTotalPrice.toLocaleString() + '원';
                //console.log(orgPrice.innerHTML + ":" + discountPrice.innerHTML + ":" + totalPrice.innerHTML);
            });

        }

    </script>

</head>
<body>
<div id="wrapper">
    <header>
        <div class="top">
            <div>
                <a href="#">로그인</a>
                <a href="#">회원가입</a>
                <a href="#">마이페이지</a>
                <a href="#"><i class="fa fa-shopping-cart" aria-hidden="true"></i>&nbsp;장바구니</a>
            </div>
        </div>
        <div class="logo">
            <div>
                <a th:href="@{/}"><img th:src="@{/images/header_logo.png}" alt="로고" /></a>
                <form action="#">
                    <input type="text" name="search"/>
                    <button><i class="fa fa-search"></i></button>
                </form>
            </div>

        </div>
        <div class="menu">
            <div>
                <ul>
                    <li><a href="#">히트상품</a></li>
                    <li><a href="#">추천상품</a></li>
                    <li><a href="#">최신상품</a></li>
                    <li><a href="#">인기상품</a></li>
                    <li><a href="#">할인상품</a></li>
                </ul>
                <ul>
                    <li><a href="#">쿠폰존</a></li>
                    <li><a href="#">사용후기</a></li>
                    <li><a href="#">개인결제</a></li>
                    <li><a href="#">고객센터</a></li>
                    <li><a href="#">FAQ</a></li>
                </ul>
            </div>
        </div>
    </header>
    <main id="product">

        <!-- 장바구니 페이지 시작 -->
        <section class="cart">

            <!-- 제목, 페이지 네비게이션 -->
            <nav>
                <script th:src="@{/js/util.js}"></script>
                <h1>장바구니</h1>
                <p>
                    HOME > <span>패션·의류·뷰티</span> > <strong>장바구니</strong>
                </p>
            </nav>
            <div id="cartList">
                <!-- 장바구니 목록 -->
                <div>
                    <label for="">
                        <input type="checkbox" name="all">
                        <span>전체선택</span>
                    </label>
                    <a href="" id="cartDelete">선택삭제</a>
                </div>
                <div class="listForCompany" th:each="map : ${cartProducts}">
                    <p class="cartProdCompany" th:text="${map.key}">회사명</p>

                    <div th:each="cartProduct, index:${map.value}" class="productList"> <!--productList를 반복 시키면 됨!!-->
                        <div class="productSelect">
                            <a href="">x</a>
                        </div>
                        <div class="productInfo">
                            <input type="checkbox" name="selectedCart" onclick="calculateTotalPrice()">
                            <input type="hidden" th:value="${cartProduct.cartProdNo}">
                            <a href="#"><img th:src="@{/uploads/__${cartProduct.thumb190}__}" alt="" style="width:80px"></a><!--80*80 사이즈로 변경-->
                            <div>
                                <p><a href="#">[[${cartProduct.prodName}]]</a></p>
                                <p>[[${cartProduct.prodInfo}]]</p>
                                <p th:if="${cartProduct.optValue1 != null}">
                                    <span th:text="'옵션: ' + ${cartProduct.optValue1}"></span>
                                    <span th:if="${cartProduct.optValue2 != null}">
                                        <span th:text="' ) ' + ${cartProduct.optValue2}"></span>
                                        <span th:if="${cartProduct.optValue3 != null}">
                                        <span th:text="' / ' + ${cartProduct.optValue3}"></span>
                                    </span>
                                </span>
                                </p>
                                <p>4/17(수) 이내 도착확률 86%</p>
                            </div>
                            <div>
                                <label for="">
                                    <button class="decrease" onclick="changeNum(-1)">-</button>
                                    <input class="prodCount" name="num" type="text" oninput="changeNum(0)" th:value="${cartProduct.count}">
                                    <button class="increase" onclick="changeNum(1)">+</button>
                                </label>
                            </div>
                            <div>
                                <!--할인 전 가격 출력 옵션 있는경우/ 없는경우-->
                                <p class="org_price" th:if="${cartProduct.optValue1}!= null">
                                    <span class="org_price_value" style="text-decoration: line-through; color: #7f7f7f" th:text="${#numbers.formatInteger(cartProduct.optPrice * cartProduct.count, 3, 'COMMA')}"></span>
                                    <span style="color: #ed2f2f; font-weight: bold" th:text="'↓' + ${cartProduct.prodDiscount} + '%'"></span>
                                    <input class="price" type="hidden" th:value="${cartProduct.optPrice}">
                                </p>
                                <p class="org_price" th:if="${cartProduct.optValue1}== null">
                                    <span class="org_price_value" style="text-decoration: line-through; color: #7f7f7f" th:text="${#numbers.formatInteger(cartProduct.prodPrice * cartProduct.count , 3, 'COMMA')}"></span>
                                    <span style="color: #ed2f2f; font-weight: bold" th:text="'↓' + ${cartProduct.prodDiscount} + '%'"></span>
                                    <input class="price" type="hidden" th:value="${cartProduct.prodPrice}">
                                </p>

                                <!--할인 후 가격 출력 옵션 있는경우/ 없는경우-->
                                <p class="dis_price" th:if="${cartProduct.optValue1} == null" th:text="${#numbers.formatInteger((cartProduct.prodPrice * (100 - cartProduct.prodDiscount) * cartProduct.count * 0.01), 3, 'COMMA')}"></p>
                                <p class="dis_price" th:if="${cartProduct.optValue1} != null" th:text="${#numbers.formatInteger((cartProduct.optPrice * (100 - cartProduct.prodDiscount) * cartProduct.count * 0.01), 3, 'COMMA')}"></p>
                                <input class="dis_prod" type="hidden" th:value="${cartProduct.prodDiscount}">
                                <input class="delivery_fee" type="hidden" th:value="${cartProduct.prodDeliveryFee}">
                                <p>(100g당 1026원, 총 용량 2000g)</p>
                                <a href="">혜택변경</a>
                            </div>
                        </div>
                    </div>
                    <div style="background-color: #dadada ; margin: 10px ; padding: 10px" >
                        <span class="sum_org_price">상품 0원</span>
                        <span class="delivery_price"> + 배송비 0원</span>
                        <span class="discount_price"> - 할인 0원</span>
                        <span class="total_price"> = 총 0원</span>
                    </div>
                </div>

            </div>

            <!-- 장바구니 전체합계 -->
            <div class="total">
                <h2>전체합계</h2>
                <table border="0">
                    <tr>
                        <td>상품수</td>
                        <td>1</td>
                    </tr>
                    <tr>
                        <td>상품금액</td>
                        <td>27,000</td>
                    </tr>
                    <tr>
                        <td>할인금액</td>
                        <td>-1,000</td>
                    </tr>
                    <tr>
                        <td>배송비</td>
                        <td>0</td>
                    </tr>
                    <tr>
                        <td>포인트</td>
                        <td>260</td>
                    </tr>
                    <tr>
                        <td>전체주문금액</td>
                        <td>26,000</td>
                    </tr>
                </table>
                <input type="submit" name="" value="주문하기">
            </div>

        </section>
        <!-- 장바구니 페이지 끝 -->
    </main>
    <footer>
        <ul>
            <li><a href="#">회사소개</a></li>
            <li><a href="#">서비스이용약관</a></li>
            <li><a href="#">개인정보처리방침</a></li>
            <li><a href="#">전자금융거래약관</a></li>
        </ul>
        <div>
            <p><img src="../images/footer_logo.png" alt="로고" /></p>
            <p>
                <strong>(주)롯데ON</strong><br />
                서울특별시 송파구 올림픽로 300 롯데월드타워 26층 (역삼동 강남파이낸스센터)<br />
                대표이사 : 김사무엘상현, 정준호, 강성현<br />
                사업자등록번호 : 529-85-00774(롯데쇼핑(주) e커머스사업부)<br />
                통신판매업 신고 : 서울송파 제0158호<br>
                호스팅 서비스사업자 : 롯데쇼핑(주) e커머스사업부
            </p>
            <p>
                <strong>고객센터</strong><br />
                Tel : 1899-7000(유료) (평일 09:00~18:00)<br />
                Fax : 051-123-4567 | E-mail : lotteon@lotte.net<br />
            </p>
        </div>
    </footer>
    <button type="button" id="top">상단이동</button>
</div>
</body>
</html>


-->