<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{/layout/productLayout.html}">
<!--내용 시작-->
    <!-- 상품 상세페이지 시작 -->
    <section class="view" layout:fragment="content">
        <script th:inline="javascript">
            // 옵션 항목 출력 버튼
            function dropOption() {
                const optionList = event.target.nextElementSibling;
                if (optionList.style.display === "block") {
                    optionList.style.display = "none"; // 옵션 박스 숨기기
                } else {
                    optionList.style.display = "block"; // 옵션 박스 보이기
                }
            }
            // 옵션 선택
            function selectOption() {
                const label = event.target.parentNode // 버튼의 부모
                const SelectOption = label.parentNode // 버튼의 부모의 부모
                const prodOption = SelectOption.parentNode // 버튼의 부모의 부모의 부모
                const selectedOption = prodOption.parentNode.querySelector('.selectedOption');
                const selectOptionNo = prodOption.querySelector('.selectOptionNo'); // 선택한 옵션 번호
                const btnSelectOption = prodOption.querySelector('.btnSelectOption'); // 옵션 선택 버튼
                const btnSelectOptionAll = prodOption.parentNode.querySelectorAll('.btnSelectOption'); // 옵션 선택 버튼 전부


                const optNo = label.querySelector('.optionNo').value; // 옵션 번호
                const optionList = event.target.parentNode.parentNode;
                const optionName = event.target.innerText; // 옵션 이름
                const optionValue = event.target.nextElementSibling.value; // 옵션 가격
                const selectedOptionName = selectedOption.querySelectorAll('h4'); // 선택된 옵션 이름들

                // 마지막 옵션인지 체크
                if (prodOption.nextElementSibling.className === "prodOption"){
                    // 마지막 옵션이 아닌 경우
                    selectOptionNo.value = optNo;
                    btnSelectOption.innerText = optionName;
                    SelectOption.style.display = "none";
                }else {
                    selectOptionNo.value = optNo;
                    btnSelectOption.innerText = optionName;
                    SelectOption.style.display = "none";
                    // 이미 선택된 옵션인지 체크
                    let optionCheck = 0;
                    // 이미 선택된 옵션이 아닐경우
                    if (optionCheck === 0) {
                        const prodOptions = prodOption.parentNode.querySelectorAll('.prodOption');
                        let selectedOptName = "";
                        let selectedOptNo = "";
                        Array.from(prodOptions).forEach(function (option, index) {
                            const optName = option.querySelector('.btnSelectOption').innerText;
                            const optNo = option.querySelector('.selectOptionNo').value;
                            console.log(optName);
                            console.log(optNo);
                            if (index > 0) {selectedOptName += "_";}
                            if (index > 0) {selectedOptNo += "_";}
                            selectedOptName += optName;
                            selectedOptNo += optNo;
                        })
                        console.log(selectedOptName);
                        console.log(selectedOptNo);
                        const matchingDTOs = findOptionInfo(selectedOptNo);

                        const selected = `<div>
                                    <h4>${selectedOptName}</h4>
                                    <div class="count">
                                        <button class="decrease" onclick="changeNum(-1)">-</button>
                                        <input type="text" name="num" class="numInput" value="1" oninput="changeNum(0)"/>
                                        <button class="increase" onclick="changeNum(1)">+</button>
                                    </div>
                                    <div class="optionPrice">
                                        <span>${matchingDTOs.optPrice}원</span>
                                        <span>x</span>
                                    </div>
                                </div>`;
                        selectedOption.insertAdjacentHTML('beforeend', selected);
                        let optionMap = [[${OptionDTOs.optionMap}]];
                        const optionName = Object.keys(optionMap)
                        Array.from(btnSelectOptionAll).forEach(function (optionBtn, index){
                            optionBtn.innerText = optionName[index];
                        })
                    }
                }
            }

            /* 3일후 계산하여 배송예정일에 출력 */
            document.addEventListener('DOMContentLoaded', function() {
                // 오늘 날짜 구하기
                var today = new Date();

                // 3일 후의 날짜 계산
                var deliveryDate = new Date(today);
                deliveryDate.setDate(today.getDate() + 3); // 오늘 날짜에 3일을 더함

                // 도착 예정 날짜 형식 지정
                var dayNames = ['일', '월', '화', '수', '목', '금', '토'];
                var dayOfWeek = dayNames[deliveryDate.getDay()]; // 요일
                var month = deliveryDate.getMonth() + 1; // 월 (0부터 시작하므로 +1 필요)
                var dayOfMonth = deliveryDate.getDate(); // 일

                // 도착 예정 날짜 문자열 생성 (예: "모레(금) 7/8 도착예정")
                var arrivalDateString = `모레(${dayOfWeek}) ${month}/${dayOfMonth} 도착예정`;

                // 도착 예정 날짜 출력
                var arrivalElement = document.getElementById('arrivalDate');
                arrivalElement.textContent = arrivalDateString;
            });

            /* +, - 버튼 눌렀을 때 동작하며 할인 금액 계산하여 총 액에나타나게함 */
            function changeNum(change) {
                var numInput = event.target.parentNode.querySelector('input');
                var inputPrice = document.getElementById("totalPrice");
                //파싱된 형태 그대로 가져와서 ',' 쉼표를 제거하여 사용함.
                var priceText = document.getElementById("disPrice").innerText;
                var price = parseFloat(priceText.replace(',', ''));

                var currentValue = parseInt(numInput.value) + change;

                // 최소값은 1, 최대값은 99로 제한
                if (currentValue < 1) {
                    currentValue = 1;
                } else if (currentValue > 99) {
                    currentValue = 99;
                }

                numInput.value = currentValue; // 변경된 값 적용

                var totalPrice = price * currentValue;
                if (!isNaN(totalPrice)) {
                    // 금액 콤마 표시를 위해 포멧팅
                    var formattedTotalPrice = new Intl.NumberFormat('ko-KR').format(totalPrice);
                    inputPrice.innerText = formattedTotalPrice;
                } else {
                    inputPrice.innerText = "0";
                }
            }

            // 사용자가 선택한 옵션에 알맞은 재고와 가격 찾는 함수
            let OptionDetailDTOs = [[${OptionDTOs.optionDetailDTOs}]];
            function findOptionInfo(optionNos) {
                const optionNosArray = optionNos.split('_');
                let optNo1 = optionNosArray[0];
                let optNo2 = optionNosArray[1];
                let optNo3 = optionNosArray[2];

                // OptionDetailDTOs 배열 해체하여 단일 배열로 만들기
                const flatDTOs = OptionDetailDTOs.flat();
                console.log(flatDTOs);

                // 사용자 입력과 DTO의 값 비교하여 일치하는 DTO 반환
                // 숫자라서 == 써야함..
                const matchingDTO = flatDTOs.find(dto =>
                    dto.optNo1 == optNo1 && dto.optNo2 == optNo2 && dto.optNo3 == optNo3
                );
                return matchingDTO;
            }
        </script>

        <!-- 제목, 페이지 네비게이션 -->
        <nav>
            <h1>상품보기</h1>
            <p>
                HOME > <span>패션·의류·뷰티</span> > <strong>남성의류</strong>
            </p>
        </nav>

        <!-- 상품 전체 정보 내용 -->
        <article class="info">
            <div class="image">
                <img th:src="@{/uploads/__${product.thumb456}__}" alt="상품이미지"/>
            </div>
            <div class="summary">
                <nav>
                    <h1>(주)[[${product.prodCompany}]]</h1>
                    <h2>상품번호&nbsp;:&nbsp;<span>[[${product.prodNo}]]</span></h2>
                </nav>
                <nav>
                    <h3>[[${product.prodName}]]</h3>
                    <p>[[${product.prodInfo}]]</p>
                    <h5 class="rating star4"><a href="#">상품평보기</a></h5>
                </nav>
                <nav>
                    <div class="org_price">
                        <del th:text="${#numbers.formatInteger(product.prodPrice, 3, 'COMMA')}" id="prodPrice"></del>
                        <span>[[${product.prodDiscount}]]%</span>
                    </div>
                    <div class="dis_price">
                        <ins id="disPrice" th:text="${#numbers.formatInteger((product.prodPrice * (100 - product.prodDiscount) * 0.01), 3, 'COMMA')}"></ins>
                    </div>
                </nav>
                <nav>
                    <span class="delivery">무료배송</span>
                    <span class="arrival" id="arrivalDate"></span>
                    <span class="desc">본 상품은 국내배송만 가능합니다.</span>
                </nav>
                <nav>
                    <span class="card cardfree"><i>아이콘</i>무이자할부</span>&nbsp;&nbsp;
                    <span class="card cardadd"><i>아이콘</i>카드추가혜택</span>
                </nav>
                <nav>
                    <span class="origin">원산지-상세설명 참조</span>
                </nav>
                <img src="../images/vip_plcc_banner.png" alt="100원만 결제해도 1만원 적립!" class="banner" />

                <!--
                    옵션 선택 박스 (product.css 515줄)
                    - 옵션이 없는 상품은 옵션 선택 태그 출력 x
                    - 옵션이 있는 상품은 옵션을 선택하지 않으면 다음으로 넘어가지 않음
                -->
                <div class="prodOption" th:each="option : ${OptionDTOs.optionMap}">
                    <input type="hidden"  class="selectOptionNo"/>
                    <button class="btnSelectOption" onclick="dropOption()" th:text="${option.key}"></button>
                    <ul class="SelectOption">
                        <label th:each="value : ${option.value}">
                            <li onclick="selectOption()" th:text="${value.optValue}"></li>
                            <input type="hidden" class="optionNo" th:value="${value.optNo}">
                        </label>
                    </ul>
                </div>

                <div class="selectedOption">

                </div>



                <div class="total">
                    <span id="totalPrice" th:text="${#numbers.formatInteger((product.prodPrice * (100 - product.prodDiscount) * 0.01), 3, 'COMMA')}"></span>
                    <em>총 상품금액</em>
                </div>


                <div class="button">
                    <input type="button" class="order" value="구매하기"/>
                    <input type="button" class="cart"  value="장바구니"/>
                    <input type="button" class="wish"  value="찜하기"/>
                </div>
            </div>
        </article>

        <!-- 상품 정보 내용 -->
        <article class="detail">
            <nav>
                <h1>상품정보</h1>
            </nav>
            <!-- 상품상세페이지 이미지 -->
            <img th:src="@{/uploads/__${product.thumb940}__}" alt="상세페이지1">
        </article>

        <!-- 상품 정보 제공 고시 내용 -->
        <article class="notice">
            <nav>
                <h1>상품 정보 제공 고시</h1>
                <p>[전자상거래에 관한 상품정보 제공에 관한 고시] 항목에 의거 등록된 정보입니다.</p>
            </nav>
            <table border="0">
                <tr>
                    <td>상품번호</td>
                    <td>10110125435</td>
                </tr>
                <tr>
                    <td>상품상태</td>
                    <td>새상품</td>
                </tr>
                <tr>
                    <td>부가세 면세여부</td>
                    <td>과세상품</td>
                </tr>
                <tr>
                    <td>영수증발행</td>
                    <td>발행가능 - 신용카드 전표, 온라인 현금영수증</td>
                </tr>
                <tr>
                    <td>사업자구분</td>
                    <td>사업자 판매자</td>
                </tr>
                <tr>
                    <td>브랜드</td>
                    <td>블루포스</td>
                </tr>
                <tr>
                    <td>원산지</td>
                    <td>국내생산</td>
                </tr>
            </table>
            <table border="0">
                <tr>
                    <td>제품소재</td>
                    <td>상세정보 직접입력</td>
                </tr>
                <tr>
                    <td>색상</td>
                    <td>상세정보 직접입력</td>
                </tr>
                <tr>
                    <td>치수</td>
                    <td>상세정보 직접입력</td>
                </tr>
                <tr>
                    <td>제조자/수입국</td>
                    <td>상세정보 직접입력</td>
                </tr>
                <tr>
                    <td>제조국</td>
                    <td>상세정보 직접입력</td>
                </tr>
                <tr>
                    <td>취급시 주의사항</td>
                    <td>상세정보 직접입력</td>
                </tr>
                <tr>
                    <td>제조연월</td>
                    <td>상세정보 직접입력</td>
                </tr>
                <tr>
                    <td>품질보증기준</td>
                    <td>상세정보 직접입력</td>
                </tr>
                <tr>
                    <td>A/S 책임자와 전화번호</td>
                    <td>상세정보 직접입력</td>
                </tr>
                <tr>
                    <td>주문후 예상 배송기간</td>
                    <td>상세정보 직접입력</td>
                </tr>
                <tr>
                <td colspan="2">구매, 교환, 반품, 배송, 설치 등과 관련하여 추가비용, 제한조건 등의 특이사항이 있는 경우</td>
                </tr>
            </table>
            <p class="notice">
                소비자가 전자상거래등에서 소비자 보호에 관한 법률 제 17조 제1항 또는 제3항에 따라 청약철회를 하고
                동법 제 18조 제1항 에 따라 청약철회한 물품을 판매자에게 반환하였음에도 불구 하고 결제 대금의
                환급이 3영업일을 넘게 지연된 경우, 소비자 는 전자상거래등에서 소비자보호에 관한 법률 제18조
                제2항 및 동법 시행령 제21조 2에 따라 지연일수에 대하여 전상법 시행령으로 정하는 이율을 곱하여
                산정한 지연이자(“지연배상금”)를 신청할 수 있습니다. 아울러, 교환∙반품∙보증 및 결제대금의
                환급신청은 [나의쇼핑정보]에서 하실 수 있으며, 자세한 문의는 개별 판매자에게 연락하여 주시기 바랍니다.
            </p>
        </article>

        <!-- 상품 리뷰 내용 -->
        <article class="review">
            <nav>
                <h1>상품리뷰</h1>

            </nav>
            <ul>
                <li>
                    <div>
                        <h5 class="rating star4">상품평</h5>
                        <span>seo******	2018-07-10</span>
                    </div>
                    <h3>상품명1/BLUE/L</h3>
                    <p>
                        가격대비 정말 괜찮은 옷이라 생각되네요 핏은 음...제가 입기엔 어깨선이 맞고 루즈핏이라 하기도 좀 힘드네요.
                        아주 약간 루즈한정도...?그래도 이만한 옷은 없다고 봅니다 깨끗하고 포장도 괜찮고 다음에도 여기서 판매하는
                        제품들을 구매하고 싶네요 정말 만족하고 후기 남깁니다 많이 파시길 바래요 ~ ~ ~
                    </p>
                </li>
                <li>
                    <div>
                        <h5 class="rating star4">상품평</h5>
                        <span>seo******	2018-07-10</span>
                    </div>
                    <h3>상품명1/BLUE/L</h3>
                    <p>
                        가격대비 정말 괜찮은 옷이라 생각되네요 핏은 음...제가 입기엔 어깨선이 맞고 루즈핏이라 하기도 좀 힘드네요.
                        아주 약간 루즈한정도...?그래도 이만한 옷은 없다고 봅니다 깨끗하고 포장도 괜찮고 다음에도 여기서 판매하는
                        제품들을 구매하고 싶네요 정말 만족하고 후기 남깁니다 많이 파시길 바래요 ~ ~ ~
                    </p>
                </li>
                <li>
                    <div>
                        <h5 class="rating star4">상품평</h5>
                        <span>seo******	2018-07-10</span>
                    </div>
                    <h3>상품명1/BLUE/L</h3>
                    <p>
                        가격대비 정말 괜찮은 옷이라 생각되네요 핏은 음...제가 입기엔 어깨선이 맞고 루즈핏이라 하기도 좀 힘드네요.
                        아주 약간 루즈한정도...?그래도 이만한 옷은 없다고 봅니다 깨끗하고 포장도 괜찮고 다음에도 여기서 판매하는
                        제품들을 구매하고 싶네요 정말 만족하고 후기 남깁니다 많이 파시길 바래요 ~ ~ ~
                    </p>
                </li>
                <li>
                    <div>
                        <h5 class="rating star4">상품평</h5>
                        <span>seo******	2018-07-10</span>
                    </div>
                    <h3>상품명1/BLUE/L</h3>
                    <p>
                        가격대비 정말 괜찮은 옷이라 생각되네요 핏은 음...제가 입기엔 어깨선이 맞고 루즈핏이라 하기도 좀 힘드네요.
                        아주 약간 루즈한정도...?그래도 이만한 옷은 없다고 봅니다 깨끗하고 포장도 괜찮고 다음에도 여기서 판매하는
                        제품들을 구매하고 싶네요 정말 만족하고 후기 남깁니다 많이 파시길 바래요 ~ ~ ~
                    </p>
                </li>
                <li>
                    <div>
                        <h5 class="rating star4">상품평</h5>
                        <span>seo******	2018-07-10</span>
                    </div>
                    <h3>상품명1/BLUE/L</h3>
                    <p>
                        가격대비 정말 괜찮은 옷이라 생각되네요 핏은 음...제가 입기엔 어깨선이 맞고 루즈핏이라 하기도 좀 힘드네요.
                        아주 약간 루즈한정도...?그래도 이만한 옷은 없다고 봅니다 깨끗하고 포장도 괜찮고 다음에도 여기서 판매하는
                        제품들을 구매하고 싶네요 정말 만족하고 후기 남깁니다 많이 파시길 바래요 ~ ~ ~
                    </p>
                </li>
            </ul>
            <div class="paging">
                <span class="prev">
                    <a href="#"><&nbsp;이전</a>
                </span>
                <span class="num">
                    <a href="#" class="on">1</a>
                    <a href="#">2</a>
                    <a href="#">3</a>
                    <a href="#">4</a>
                    <a href="#">5</a>
                    <a href="#">6</a>
                    <a href="#">7</a>
                </span>
                <span class="next">
                    <a href="#">다음&nbsp;></a>
                </span>
            </div>

        </article>

    </section>
    <!-- 상품 상세페이지 끝 -->
<!--내용 끝-->
</html>
