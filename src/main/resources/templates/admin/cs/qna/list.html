<html xmlns:th="http://www.thymeleaf.org"
    xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{/layout/adminLayout.html}">

<!--내용 시작-->
    <section id="admin-cs-list" layout:fragment="content">
        <script>
            window.onload = function (){
            // 체크박스 선택
            const qnaCheckBox = document.querySelectorAll('.qnaCheckBox');
            // 선택삭제 버튼
            const qnaDeleteBtn = document.getElementById('qnaDeleteBtn');

            qnaDeleteBtn.onclick = function (e){
                // 삭제할 상품의 번호를 저장하는 배열
                let qna_qnaNo = [];
                // forEach로 반복하며 checked된 상품 번호 찾기
                qnaCheckBox.forEach(check => {
                    if(check.checked){
                        const checkBox = check;
                        const div = checkBox.closest('tr');
                        const qna_qnaNoInput = div.querySelector('.qna_qnaNo');
                        if (qna_qnaNoInput) {
                            // qna_qnaNoInput이 존재할 때만 값 추가
                            qna_qnaNo.push(qna_qnaNoInput.value);
                            console.log("qna qnaNo:", qna_qnaNo);
                        }else{
                            console.error('qna qnaNo input element not found');
                        }
                    }
                });
                // 삭제
                let result = false;
                if(qna_qnaNo.length != 0){
                    result = confirm("선택하신 상품을 장바구니에서 삭제하시겠습니까?");
                }else{
                    return;
                }
                if(result){
                    const jsonData = {
                        "qna_qnaNo" : qna_qnaNo
                    }
                    fetch("/lotteon/admin/cs/qna/delete", {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(jsonData)
                    })
                        .then(response => {
                            console.log(response);
                            if(!response.ok){
                                throw new Error('삭제에 실패했습니다.');
                            }
                            return response.json()
                        })
                        .then(data => {
                            console.log(data);
                            console.log(data.data);
                            if(data.data === '삭제 성공'){
                                window.location.href = "/lotteon/admin/cs/qna/list";
                            }
                        })
                        .catch(err => console.log(err));
                }else{
                    qna_qnaNo.length = 0;
                    alert("취소되었습니다.");
                }
            }
            // 전체 선택
            const totalCheckBox = document.getElementsByClassName('totalCheckBox')[0];
            let checkedTurn = 0;

            totalCheckBox.onclick = function (e){

                const qnaCheckBox = Array.from(document.getElementsByClassName('qnaCheckBox'));

                if(checkedTurn === 0){
                    qnaCheckBox.forEach(function(checkbox){
                        checkbox.checked = true;
                    });
                    checkedTurn = 1;
                }else{
                    qnaCheckBox.forEach(function(checkbox){
                        checkbox.checked = false;
                    });
                    checkedTurn = 0;
                    }
                }
            }
        </script>

        <nav>
            <h3>문의하기 목록</h3>
            <p>
                HOME > 고객센터 > <strong>문의하기</strong>
            </p>
        </nav>
        <!-- qna 컨텐츠 시작 -->
        <section>
            <div>
                <select name="qnaCate">
                    <option>1차선택</option>
                    <option value="[회원]">회원</option>
                    <option value="[쿠폰/이벤트]">쿠폰/이벤트</option>
                    <option value="[주문/결제]">주문/결제</option>
                    <option value="[배송]">배송</option>
                    <option value="[취소/반품/환불]">취소/반품/환불</option>
                    <option value="[안전결제]">안전결제</option>
                </select>
                <select name="qnaType">
                    <option>2차선택</option>
                    <option value="[고객서비스]">고객서비스</option>
                    <option value="[이벤트당첨]">이벤트당첨</option>
                    <option value="[안전거래]">안전거래</option>
                    <option value="[위해상품]">위해상품</option>
                </select>
            </div>
            <table class="qna">
                <tr>
                    <th><input type="checkbox" class="totalCheckBox" name="all"/></th>
                    <th>번호</th>
                    <th>1차유형</th>
                    <th>2차유형</th>
                    <th>제목</th>
                    <th>작성자</th>
                    <th>작성일</th>
                    <th>상태</th>
                </tr>

                <tr th:each="qna, index:${pageResponseDTO.dtoList}">
                    <td><input type="checkbox" class="qnaCheckBox" name="글번호"/></td>
                    <td>
                        <input type="hidden" class="qna_qnaNo" th:value="${qna.qnaNo}">
                        <span th:text="${pageResponseDTO.startNo - index.index}"></span>
                    </td>
                    <td th:text="${qna.qnaCate}" style="white-space: nowrap;"></td>
                    <td th:text="${qna.qnaType}" style="white-space: nowrap;"></td>
                    <td>
                        <span>
                            <a th:href="@{/admin/cs/qna/view(qnaNo=${qna.qnaNo})}">
                                <span th:text="${qna.qnaTitle}"></span>
                            </a>
                        </span>
                    </td>
                    <td th:text="${qna.userId}"></td>
                    <td th:if="${qna.qnaDate != null}" th:text="${#temporals.format(qna.qnaDate, 'yyyy-MM-dd')}" style="white-space: nowrap;" ></td>
                    <td th:text="${qna.qnaStatus}"></td>
                </tr>
            </table>


            <input type="button" class="qnaDeleteBtn" id="qnaDeleteBtn" value="선택삭제" style="background-color: #9e9e9e; color: white; border: none; padding: 10px 20px; cursor: pointer;"/>


            <div class="paging">
                <span class="prev">
                    <!-- 이전 버튼 -->
                    <a th:if="${pageResponseDTO.prev}" th:href="@{/admin/cs/qna/list(pg=${pageResponseDTO.start-1})}"><&nbsp;이전</a>
                </span>
                    <!-- 페이지 링크 -->
                <span class="num">
                    <th:block th:each="num:${#numbers.sequence(pageResponseDTO.start, pageResponseDTO.end)}">
                <a th:href="@{/admin/cs/qna/list(pg=${num})}" th:class="${pageResponseDTO.pg == num} ? 'current' : 'off'" th:text="${num}"></a>
                    </th:block>
                </span>
                    <!-- 다음 버튼 -->
                <span class="next">
                    <a th:if="${pageResponseDTO.next}" th:href="@{/admin/cs/qna/list(pg=${pageResponseDTO.end+1})}">다음</a>
                </span>
                </div>
        </section>
        <!-- 상품목록 컨텐츠 끝 -->
    </section>
<!--내용 끝-->
</html>